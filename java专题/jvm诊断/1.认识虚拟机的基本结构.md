# 认识虚拟机的基本结构

java虚拟机的基本结构，各个部分有什么作用，如何相互协作？

本节目标：
- 认识java虚拟机中的堆
- 了解栈的概念和使用
- 存放类型描述的永久区和数据区


## 虚拟机的基本架构

        类加载子系统                 java栈

    方法区  Java堆   直接内存区     本地方法栈

    垃圾回收系统                    pc寄存器

        执          行         引          擎


类加载子系统从文件或者是网络中加载class文件，加载的类信息存放在方法区中，常量池（byte[-128~127]）

java堆是最重要的一片区域，存放几乎所有的线程共享，它与java应用密切相关的内存区域。


java NIO允许java使用本地直接内存（直接向系统申请空间）

垃圾回收是虚拟机重要的组成部分，垃圾回收的部分包括:

- 方法区  
- 堆
- 直接内存区


每一个java虚拟机线程都有一个私有的java栈，栈中存在栈帧。java栈保存着局部变量、方法参数、返回地址。

pc寄存器每个线程私有的，每一个java线程会执行一个方法  pc寄存器指向方法执行的指令  如果是本地方法那么就是未定义。

执行引擎，负责执行字节码


## java虚拟机参数

-Xmx32m 最大堆内存

## 对象去了哪里

java对和java应用程序关系最为紧密的内存空间，几乎所有的对象都在堆中。

垃圾回收机制，根据回收机制的不同，结构也会不同，一种简单的是将其分代：新生代和老年代。

新生代：存放新生对象或者年龄不大的对象，新生代分为eden s0 s1也成为from和to区域，两块大小相同，互相交换内容。

老年代：存放大对象或者年龄比较大的对象


对象创建首先在eden区域，然后一次回收进入到s0，然后每次s0 s1之间进行切换，当达到一定年龄就会进入到老年期

## 出入java栈

java栈是一块私有的内存空间，它是和线程密切相关的区域，java栈中保存的是栈帧，每次调用都是出栈和入栈的一个过程

java方法两种返回方式，一种是正常返回return，一种是抛出异常。都是出栈的过程。

栈帧中至少包含局部变量表、操作数栈、帧数据

-Xss指定最大栈空间

### 局部变量表

保存函数参数以及局部变量，局部变量表中的变量旨在当前函数调用中有效，函数销毁了，局部变量表也就销毁了。


class文件的局部变量表中，显示局部变量的作用范围、所在的槽位的索引、变量名、数据类型。

槽位可以重用，如果一个局部变量过了作用域，作用域之后申明的局部变量就会使用这个槽位。

局部变量表中的数据也会被回收，只要间接或者直接对象不存在就会被回收、

### 操作数栈

栈帧中最重要的内容之一，用于保存计算的中间结果，同时作为计算过程中变量临时存储。

操作数栈也是一个先进先出数据结构，简单理解 栈求表达式的值


### 帧数据区

栈帧还需要支持常量池解析、正常方法返回异常处理的，帧数据区保存着访问常量池的指针，方便访问常量池。

如果法神异常，虚拟机需要恢复调用这个函数的栈帧，并使得调用着函数继续执行下去，虚拟机还有异常处理表，方便发生异常的时候找到处理代码

### 栈上分配

栈上分配是虚拟机的一项优化技术，它的思想是：线程私有的对象，可以分配在栈上，不需要在堆上，提高了性能。

栈上分配是逃逸技术，需要进行逃逸分析

未发生逃逸的，可以在栈上分配，而不是在堆上。

逃逸不是任何时候都开启的，只有在server的时候才可以开启逃逸

## 识别方法区

方法区是一块所有线程都共享的区域，用于保存类信息，比如字段，方法、常量池等，方法区的大小可以决定保存多少类，如果类特别多，也会发生方法区溢出。

永久区（1.6  1.7）-XX:PermSize

1.8永久区已经彻底移除，取而代之是元数据区，使用的是直接内存，与永久区不同的，如果不指定大小，可以消耗尽系统资源


33页